{% extends 'base.html' %}
{% block title %}Asignar Partidos{% endblock %}
{% block content %}
<style>
  .wrap { max-width:1600px; margin:40px auto; padding:0 16px; }
  h2 { color:#a78bfa; text-align:center; margin-bottom:14px; }

  .msg { text-align:center; margin:8px 0; }
  .msg.ok  { color:#34d399; }
  .msg.err { color:#f87171; }

  .tablebox { background:#1f2937; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.3); margin-bottom:24px; }

  table.table-assign { width:100%; border-collapse:collapse; }
  .table-assign th, .table-assign td { padding:12px 14px; border-bottom:1px solid #374151; text-align:left; vertical-align:middle; }
  .table-assign th { color:#a78bfa; font-weight:700; }

  .col-id{ width:72px; }
  .col-hora{ width:90px; }
  .col-asig{ width:360px; }
  .col-act{ min-width:520px; }

  .asig-chip{
    display:inline-flex; align-items:center; gap:.5rem;
    background:#0b1220; border:1px solid #374151; border-radius:999px;
    padding:6px 10px; line-height:1; max-width:100%;
  }
  .asig-chip .badge{
    background:#a78bfa; color:#111827; font-weight:800; border-radius:999px; padding:2px 8px; font-size:.85rem;
  }
  .asig-chip .text{
    max-width:210px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .row-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:4px; }
  .row-actions input[type="text"]{
    height:38px; background:#111827; border:1px solid #374151; border-radius:8px; color:#f3f4f6; padding:0 .8rem; box-sizing:border-box;
  }
  .row-actions input[type="text"]:focus{ outline:none; border-color:#8b5cf6; box-shadow:0 0 0 1px rgba(139,92,246,.35); }
  .rut-input{ width:180px; }
  .dv-input{ width:68px; text-align:center; text-transform:uppercase; }

  .btn{ background:#a78bfa; color:#111827; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
  .btn:hover{ background:#8b5cf6; color:#fff; }
  .btn-ghost{ background:#111827; border:1px solid #a78bfa; color:#a78bfa; }
  .btn-ghost:hover{ background:#0c1220; border-color:#8b5cf6; color:#fff; }

  .help {
    font-size:.8rem;
    color:#9ca3af;
    margin-top:4px;
  }

  @media (max-width:960px){
    .col-asig{ width:300px; }
    .col-act{ min-width:420px; }
    .rut-input{ width:160px; }
  }
  @media (max-width:720px){
    .rut-input{ width:140px; }
    .dv-input{ width:60px; }
    .asig-chip .text{ max-width:160px; }
  }
</style>

<div class="wrap">
  <h2>Asignar √Årbitros y Turno a Partidos</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="msg {% if message.tags == 'success' %}ok{% else %}err{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  {# Agrupamos partidos por fecha (jornada) #}
  {% regroup partidos by fecha as fechas_partidos %}

  {% for grupo in fechas_partidos %}
    {% with turno_club=grupo.list.0.club_turno_nombre %}
      <h3 style="color:#a78bfa; margin:18px 0 8px;">
        üìÖ Fecha {{ forloop.counter }} ‚Äî {{ grupo.grouper|date:"Y-m-d" }}
        {% if turno_club %}
          ¬∑ <span style="color:#e5e7eb;">Club de turno: <strong>{{ turno_club }}</strong></span>
        {% endif %}
      </h3>
    {% endwith %}

    <div class="tablebox">
      <table class="table-assign">
        <thead>
          <tr>
            <th class="col-id">ID</th>
            <th class="col-hora">Hora</th>
            <th>Partido</th>
            <th class="col-asig">Asignaci√≥n</th>
            <th class="col-act">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for p in grupo.list %}
          <tr>
            <td class="col-id">{{ p.id }}</td>
            <td class="col-hora">{{ p.hora|default:"‚Äî" }}</td>
            <td>{{ p.club_local }} vs {{ p.club_visitante }}</td>

            <td class="col-asig">
              {# √Årbitro -> mostrar nombre y apellidos #}
              {% if p.nombre_arbitro %}
                <span class="asig-chip"
                      title="RUT √Årbitro: {{ p.rut_arbitro }}-{{ p.dv_arbitro }}">
                  <span class="badge">√Årbitro</span>
                  <span class="text">{{ p.nombre_arbitro }}</span>
                </span>
              {% else %}
                <span class="asig-chip"><span class="text">Sin √°rbitro</span></span>
              {% endif %}

              <span style="display:inline-block;width:8px;"></span>

              {# Turno -> mostrar nombre y apellidos #}
              {% if p.nombre_turno %}
                <span class="asig-chip"
                      title="RUT Turno: {{ p.rut_turno }}-{{ p.dv_turno }}">
                  <span class="badge">Turno</span>
                  <span class="text">{{ p.nombre_turno }}</span>
                </span>
              {% else %}
                <span class="asig-chip"><span class="text">Sin turno</span></span>
              {% endif %}
            </td>

            <td class="col-act">
              {# ====== Form √Årbitro ====== #}
              <form method="post" class="row-actions">
                {% csrf_token %}
                <input type="hidden" name="id_partido" value="{{ p.id }}">

                <input type="text" name="rut_arbitro" class="rut-input"
                       placeholder="RUT √Årbitro (sin DV)" inputmode="numeric"
                       pattern="[0-9]{6,8}" title="S√≥lo n√∫meros (6 a 8 d√≠gitos)">

                <input type="text" name="dv_arbitro" class="dv-input"
                       placeholder="DV" maxlength="1" pattern="[0-9Kk]" title="0-9 o K">

                <button type="submit" name="assign_arbitro" value="1" class="btn">Asignar √Årbitro</button>

                {% if p.rut_arbitro and p.dv_arbitro %}
                  <button type="submit" name="unassign" value="1" class="btn btn-ghost">Quitar √Årbitro</button>
                {% endif %}
              </form>

              {# ====== Form Turno ====== #}
              <form method="post" class="row-actions" style="margin-top:8px;">
                {% csrf_token %}
                <input type="hidden" name="id_partido" value="{{ p.id }}">

                <input type="text" name="rut_turno" class="rut-input"
                       placeholder="RUT Turno (sin DV)" inputmode="numeric"
                       pattern="[0-9]{6,8}" title="S√≥lo n√∫meros (6 a 8 d√≠gitos)">

                <input type="text" name="dv_turno" class="dv-input"
                       placeholder="DV" maxlength="1" pattern="[0-9Kk]" title="0-9 o K">

                <button type="submit" name="assign_turno" value="1" class="btn">Asignar Turno</button>

                {% if p.rut_turno and p.dv_turno %}
                  <button type="submit" name="unassign_turno" value="1" class="btn btn-ghost">Quitar Turno</button>
                {% endif %}
              </form>

              <div class="help">
                La persona de <strong>Turno</strong> debe ser mayor de edad y pertenecer
                al <strong>club de turno de esta fecha</strong>.
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">No hay partidos para esta fecha.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% empty %}
    <p>No hay partidos para mostrar.</p>
  {% endfor %}

  <div style="text-align:center;margin-top:1rem;">
    <a href="{% url 'dashboard' %}" style="color:#a78bfa;">‚Üê Volver al Panel</a>
  </div>
</div>

<script>
  // Normaliza DV a may√∫scula y restringe a 1 char, y RUT solo n√∫meros
  document.addEventListener('input', (e) => {
    if (['rut_arbitro','rut_turno'].includes(e.target.name)) {
      e.target.value = (e.target.value || '').replace(/\D/g,'').slice(0,8);
    }
    if (['dv_arbitro','dv_turno'].includes(e.target.name)) {
      e.target.value = (e.target.value || '').replace(/[^0-9Kk]/g,'').toUpperCase().slice(0,1);
    }
  });
</script>
{% endblock %}
